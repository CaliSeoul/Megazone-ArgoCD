name: Build and Push Nginx to ECR

on:
  push:
    branches: ["main"]
    paths:
      - 'nginx/**' # nginx 폴더 내부의 변경 사항만 감지

# 동일한 워크플로우가 동시에 돌 때 충돌을 방지합니다. (새 작업이 들어오면 이전 작업 취소)
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Git 저장소에 다시 푸시하기 위해 필요

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Git 로그를 모두 가져와야 push 시 충돌 에러를 줄여줍니다.

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-southeast-2 # 고객님의 리전으로 변경

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build & Push Nginx Image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }} # ECR 레지스트리 URI (예: 123456789012.dkr.ecr.ap-southeast-2.amazonaws.com)
          IMAGE_REPO: seyachul9/argo # 고객님의 ECR 리포지토리 이름
          IMAGE_TAG: ${{ github.sha }} # Git 커밋 SHA를 이미지 태그로 사용
        run: |
          docker build -t $ECR_REGISTRY/$IMAGE_REPO:$IMAGE_TAG ./nginx
          docker push $ECR_REGISTRY/$IMAGE_REPO:$IMAGE_TAG
          echo "IMAGE_FULL_URI=$ECR_REGISTRY/$IMAGE_REPO:$IMAGE_TAG" >> $GITHUB_ENV # 다음 스텝에서 사용하기 위해 변수 저장

      - name: Update Kubernetes Manifests (ArgoCD Trigger)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # manifests 폴더 내의 모든 .yaml과 .yml 파일을 찾아서 이미지 업데이트
          # sed 명령어로 IMAGE_TAG_PLACEHOLDER를 실제 이미지 URI와 태그로 대체
          find manifests -name "*.y*ml" -exec sed -i "s|IMAGE_TAG_PLACEHOLDER|${{ env.IMAGE_TAG }}|g" {} +
          
          # 변경 사항이 있는지 확인 후 커밋 (변경 사항 없으면 건너뜀)
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git add manifests/*.y*ml # 변경된 yaml 파일들만 스테이징
            # [skip ci]를 넣어 자동화 커밋이 다시 Action을 실행시키지 않게 합니다.
            git commit -m "chore: Auto-deploy update image tag to ${{ env.IMAGE_TAG }} [skip ci]"

            # 다른 작업과 충돌 방지를 위해 pull 후 push 합니다.
            git pull --rebase origin main
            git push origin main
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}