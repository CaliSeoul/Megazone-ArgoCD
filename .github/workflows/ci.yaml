name: Build and Push Nginx to ECR

on:
  push:
    branches: ["main"]
    paths:
      - 'nginx/**' # nginx 폴더 내부의 변경 사항만 감지

# 동일한 워크플로우가 동시에 돌 때 충돌을 방지합니다. (새 작업이 들어오면 이전 작업 취소)
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Git 저장소에 다시 푸시하기 위해 필요

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Git 로그를 모두 가져와야 push 시 충돌 에러를 줄여줍니다.

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-southeast-2 # 고객님의 리전으로 변경

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build & Push Nginx Image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }} # ECR 레지스트리 URI (예: 123456789012.dkr.ecr.ap-southeast-2.amazonaws.com)
          IMAGE_REPO: seyachul9/argo # 고객님의 ECR 리포지토리 이름
          IMAGE_TAG: ${{ github.sha }} # Git 커밋 SHA를 이미지 태그로 사용
        run: |
          docker build -t $ECR_REGISTRY/$IMAGE_REPO:$IMAGE_TAG ./nginx
          docker push $ECR_REGISTRY/$IMAGE_REPO:$IMAGE_TAG
          echo "IMAGE_FULL_URI=$ECR_REGISTRY/$IMAGE_REPO:$IMAGE_TAG" >> $GITHUB_ENV # 다음 스텝에서 사용하기 위해 변수 저장

      - name: Update Kubernetes Manifests (ArgoCD Trigger)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # [최종 수정] 따옴표가 있어도 없어도 이미지 주소를 찾아 태그를 업데이트합니다.
          find manifests -name "*.y*ml" -exec sed -i "s|image:.*${{ env.IMAGE_REPO }}.*|image: \"${{ env.ECR_REGISTRY }}/${{ env.IMAGE_REPO }}:${{ env.IMAGE_TAG }}\"|g" {} +
          
          # 변경 사항을 스테이징하고, 실제로 바뀐 게 있을 때만 커밋/푸시합니다.
          git add manifests/*.y*ml
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: Auto-deploy update image tag to ${{ env.IMAGE_TAG }} [skip ci]"
            git pull --rebase origin main
            git push origin main
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
