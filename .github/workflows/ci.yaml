name: Build and Push Nginx to ECR

on:
  push:
    branches: ["main"]
    paths:
      - 'nginx/**' # nginx 폴더 내부의 변경 사항만 감지

# 동일한 워크플로우가 동시에 돌 때 충돌을 방지합니다. (새 작업이 들어오면 이전 작업 취소)
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Git 저장소에 다시 푸시하기 위해 필요

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Git 로그를 모두 가져와야 push 시 충돌 에러를 줄여줍니다.

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-southeast-2 # 고객님의 리전으로 변경

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build & Push Nginx Image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_REPO: seyachul9/argo
          IMAGE_TAG: ${{ github.sha }} # Git 커밋 SHA를 이미지 태그로 사용
        run: |
          docker build -t $ECR_REGISTRY/$IMAGE_REPO:$IMAGE_TAG ./nginx
          docker push $ECR_REGISTRY/$IMAGE_REPO:$IMAGE_TAG
          echo "IMAGE_FULL_URI=$ECR_REGISTRY/$IMAGE_REPO:$IMAGE_TAG" >> $GITHUB_ENV # 다음 스텝에서 사용하기 위해 변수 저장

      - name: Update Kubernetes Manifests (ArgoCD Trigger)
        env:
          # 여기서 사용할 정보들을 환경변수로 명시해줍니다.
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_REPO: seyachul9/argo
          IMAGE_TAG: ${{ github.sha }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # [가장 확실한 방법] 쉘 변수를 사용하여 주소를 조합합니다.
          FULL_IMAGE="${ECR_REGISTRY}/${IMAGE_REPO}:${IMAGE_TAG}"
          echo "DEBUG: Target Image URI is $FULL_IMAGE"
          
          # manifests 폴더 내 모든 파일에서 __IMAGE_URL__을 실제 주소로 바꿉니다.
          find manifests -name "*.y*ml" -exec sed -i "s|__IMAGE_URL__|$FULL_IMAGE|g" {} +
          
          # 제대로 바뀌었는지 로그로 확인
          echo "--- Updated Manifest ---"
          cat manifests/deployment.yaml | grep "image:"
          
          git add manifests/*.y*ml
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: Auto-deploy update image tag to ${IMAGE_TAG} [skip ci]"
            git pull --rebase origin main
            git push origin main
          fi
